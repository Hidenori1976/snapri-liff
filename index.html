<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SNAPRI 勤怠</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial; background:#f6f7f9; margin:0; padding:16px; }
    .card { max-width: 560px; margin: 0 auto; background:#fff; border-radius:14px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,.08); }
    .title { font-size: 18px; font-weight: 800; }
    .msg { margin-top: 10px; line-height: 1.7; white-space: pre-wrap; }
    .muted { margin-top: 12px; color:#666; font-size:12px; white-space: pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">勤怠処理中…</div>
    <div id="msg" class="msg">LINE情報を確認しています。</div>
    <div id="dbg" class="muted mono"></div>
    <div class="muted">この画面は自動で閉じます。</div>
  </div>

<script>
(async () => {
  const setMsg = (t) => document.getElementById("msg").textContent = t;
  const setDbg = (o) => { try { document.getElementById("dbg").textContent = JSON.stringify(o, null, 2); } catch(e){} };

  // ✅ ここだけあなたのLIFF IDにする（LINE DevelopersのLIFF ID）
  const LIFF_ID = "2008768828-dySwcSTD";

  // ✅ Supabaseのcheckin_by_qr（固定）
  const CHECKIN_ENDPOINT = "https://cwgwdpfnsxbptiskkczz.supabase.co/functions/v1/checkin_by_qr";

  // ✅ クエリ（または liff.state）から shop_id / action を拾う
  const u = new URL(location.href);

  const pick = (key) => u.searchParams.get(key) || "";
  let shopId = pick("shop_id");
  let action = pick("action") || "check_in";

  // liff.state 対応
  const state = pick("liff.state");
  if ((!shopId || !u.searchParams.get("action")) && state) {
    let decoded = state;
    try { decoded = decodeURIComponent(state); } catch(_) {}
    const qi = decoded.indexOf("?");
    const q = (qi >= 0 ? decoded.slice(qi+1) : decoded.replace(/^\//,""));
    const p = new URLSearchParams(q);
    if (!shopId) shopId = p.get("shop_id") || "";
    if (!u.searchParams.get("action")) action = (p.get("action") || action);
  }

  try {
    if (!shopId) { setMsg("エラー：shop_id がありません"); setDbg({ href: location.href }); return; }
    if (action !== "check_in" && action !== "check_out") { setMsg("エラー：action は check_in / check_out のみ"); return; }

    setDbg({ href: location.href, shopId, action, CHECKIN_ENDPOINT });

    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      setMsg("LINEログインへ移動します…");
      liff.login({ redirectUri: location.href });
      return;
    }

    const profile = await liff.getProfile();
    const lineUserId = profile.userId;

    setMsg("勤怠を送信しています…");

    const res = await fetch(CHECKIN_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ shop_id: shopId, action, line_user_id: lineUserId })
    });

    const json = await res.json().catch(() => null);
    setDbg({ status: res.status, json });

    if (!res.ok || !json || !json.ok) {
      setMsg("エラー：送信できませんでした。\n" + JSON.stringify(json));
      return;
    }

    setMsg("完了しました。");
    setTimeout(() => liff.closeWindow(), 800);

  } catch (e) {
    setDbg({ error: String(e) });
    setMsg("エラー：LINE内で開いてください。\n" + String(e));
  }
})();
</script>
</body>
</html>
